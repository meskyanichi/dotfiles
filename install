#! /bin/sh

dotfiles_dir="$HOME/.dotfiles"
ssh_dir="$HOME/.ssh"
gpg_dir="$HOME/.gnupg"
homebrew_url="https://raw.githubusercontent.com/Homebrew/install/master/install"
doom_emacs_url="https://github.com/hlissner/doom-emacs"
zshrc_local="$HOME/.zshrc.local"

if [ ! -f $ssh_dir/id_rsa ]; then
  echo "Setup $ssh_dir before proceeding."
  exit 1
fi

chmod 700 $ssh_dir
chmod 600 $ssh_dir/*

if [ ! -f $gpg_dir/secring.gpg ]; then
  echo "Setup $gpg_dir before proceeding."
  exit 1
fi

chmod 700 $gpg_dir
chmod 600 $gpg_dir/*

echo "Creating Developer directory."
mkdir -p $HOME/Developer

if [ ! -d $dotfiles_dir ]; then
  echo "Installing (git-based) dotfiles."
  git clone git@github.com:mrrooijen/dotfiles.git $dotfiles_dir
fi

echo "Linking ~/.zshrc"
ln -nfs "$dotfiles_dir/zsh/zshrc"            "$HOME/.zshrc"

echo "Linking ~/.doom.d"
ln -nfs "$dotfiles_dir/emacs/doom.d"         "$HOME/.doom.d"

echo "Linking ~/.gnupg"
ln -nfs "$dotfiles_dir/gnupg/gpg-agent.conf" "$HOME/.gnupg/gpg-agent.conf"

echo "Linking ~/.gitconfig"
ln -nfs "$dotfiles_dir/git/gitconfig"        "$HOME/.gitconfig"

echo "Linking ~/.gemrc"
ln -nfs "$dotfiles_dir/ruby/gemrc"           "$HOME/.gemrc"

echo "Initializing $zshrc_local."
touch $zshrc_local

echo "Installing fonts."
cp $dotfiles_dir/fonts/* /Library/Fonts

echo "Installing xcode command-line tools."
xcode-select --install

echo "Installing homebrew."
/usr/bin/ruby -e "$(curl -fsSL $homebrew_url)"

echo "Installing gpg."
brew install gpg

echo "Installing git."
brew install git

echo "Installing iterm."
brew cask install iterm2

echo "Installing emacs."
brew tap d12frosted/emacs-plus
brew install emacs-plus coreutils fd ripgrep pinentry-mac
ln -s /usr/local/opt/emacs-plus/Emacs.app /Applications/Emacs.app

if [ ! -d "$HOME/.emacs.d" ]; then
  git clone $doom_emacs_url ~/.emacs.d
  $HOME/.emacs.d/bin/doom install
  $HOME/.emacs.d/bin/doom refresh
fi

echo "Installing spectacle."
brew cask install spectacle

echo "Installing displayplacer."
brew tap jakehilborn/jakehilborn
brew install displayplacer
